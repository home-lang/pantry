# Publishing to npm with OIDC

This guide explains how to securely publish packages to npm using OpenID Connect (OIDC) authentication with Pantry.

## Overview

npm's trusted publishing feature allows you to publish packages from CI/CD workflows without managing long-lived npm tokens. Instead, it uses short-lived OIDC tokens that are automatically generated by your CI/CD provider.

### Benefits

- **No token management**: No need to create, store, or rotate npm tokens
- **Enhanced security**: Short-lived tokens that can't be exfiltrated
- **Automatic provenance**: Cryptographic proof of package origin
- **Audit trail**: Full transparency of who published what and from where

## Requirements

- npm CLI v11.5.1 or later (for npm CLI users) OR Pantry with OIDC support
- GitHub Actions (GitHub-hosted runners) or GitLab CI/CD (gitlab.com shared runners)
- npm account with package publishing permissions

## Setup

### 1. Configure Trusted Publisher on npm

Before you can publish with OIDC, you need to configure a trusted publisher on npmjs.com:

1. Go to [npmjs.com](https://www.npmjs.com) and sign in
2. Navigate to your package settings
3. Click on "Publishing access" or "Trusted publishers"
4. Click "Add trusted publisher"
5. Fill in the details:
   - **Provider**: Select "GitHub Actions" or "GitLab CI"
   - **Organization/User**: Your GitHub username or organization
   - **Repository**: Your repository name (e.g., `my-awesome-package`)
   - **Workflow**: Your workflow file (e.g., `.github/workflows/publish.yml`)
   - **Environment** (optional): Environment name for additional security

### 2. Configure Your Package

Add `publishConfig` to your `package.json` or `pantry.json`:

```json
{
  "name": "my-package",
  "version": "1.0.0",
  "publishConfig": {
    "registry": "https://registry.npmjs.org",
    "access": "public"
  }
}
```

**Configuration Options:**

- `registry`: Registry URL (default: `<https://registry.npmjs.org>`)
- `access`: Package access level - `"public"` or `"restricted"` (for scoped packages)
- `tag`: Distribution tag (default: `"latest"`)

### 3. Create GitHub Actions Workflow

Create `.github/workflows/publish.yml`:

```yaml
name: Publish to npm

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

# CRITICAL: Required for OIDC authentication
    permissions:
      id-token: write  # Required to request OIDC token
      contents: read   # Required to checkout code

    steps:

      - name: Checkout code

        uses: actions/checkout@v4

      - name: Setup Pantry

        run: curl -fsSL https://pantry.sh/install.sh | bash

      - name: Publish to npm

        run: pantry publish
```

**Important Notes:**

- The `id-token: write` permission is **required** for OIDC to work
- No `NPM_TOKEN` secret is needed
- The workflow file path must match what you configured on npmjs.com

## Publishing

### Basic Publishing

```bash
# Publish with OIDC (default behavior in CI/CD)
pantry publish

# Publish with dry-run to test
pantry publish --dry-run

# Publish to a specific registry
pantry publish --registry https://registry.npmjs.org
```

### Configuration Priority

Pantry determines the registry to use in this order:

1. **CLI flag**: `--registry` option takes highest priority
2. **publishConfig**: Registry from `package.json` or `pantry.json`
3. **Default**: `<https://registry.npmjs.org>`

### Examples

#### Publish to npm (default)

```json
{
  "name": "@myorg/my-package",
  "version": "1.0.0",
  "publishConfig": {
    "access": "public"
  }
}
```

```bash
pantry publish
```

#### Publish to custom registry

```json
{
  "name": "my-private-package",
  "version": "1.0.0",
  "publishConfig": {
    "registry": "https://npm.pkg.github.com",
    "access": "restricted"
  }
}
```

```bash
pantry publish
```

#### Publish to multiple registries

```yaml

- name: Publish to npm

  run: pantry publish --registry https://registry.npmjs.org

- name: Publish to GitHub Packages

  run: pantry publish --registry https://npm.pkg.github.com
```

## Provenance

Pantry automatically generates SLSA provenance attestations when publishing with OIDC. This provides cryptographic proof of:

- Where the package was built
- What workflow created it
- The source code commit SHA
- When it was published

Provenance files are generated as `{package}-{version}.provenance.json` in your working directory.

### Viewing Provenance

After publishing, you can view provenance on npm:

```bash
npm view my-package --json | grep provenance
```

Or on the npm website under "Provenance" section of your package page.

## Troubleshooting

### "OIDC authentication not available"

**Cause**: OIDC provider not detected or token not available

**Solutions**:

- Ensure you're running in a supported CI/CD environment (GitHub Actions, GitLab CI)
- Verify `id-token: write` permission is set in your workflow
- Check that environment variables are available:
  - GitHub: `ACTIONS_ID_TOKEN_REQUEST_URL` and `ACTIONS_ID_TOKEN_REQUEST_TOKEN`
  - GitLab: `CI_JOB_JWT_V2`

### "Trusted publisher validation failed"

**Cause**: OIDC claims don't match the trusted publisher configuration on npm

**Solutions**:

- Verify the workflow file path matches exactly (e.g., `.github/workflows/publish.yml`)
- Check that the repository owner/name match your npm trusted publisher config
- Ensure you're publishing from the correct branch if you specified allowed refs
- Review the OIDC claims output in the publish logs

### "Package not found in registry"

**Cause**: This is the first time publishing the package

**Solutions**:

- You cannot use OIDC for the first publish of a package
- First publish must use traditional npm token authentication:

  ```bash
  NPM_TOKEN=your_token pantry publish --no-oidc
  ```

- After first publish, configure trusted publisher on npm
- Subsequent publishes can use OIDC

### Fallback to Token Authentication

If OIDC fails, Pantry automatically falls back to token authentication:

```bash
# Set NPM_TOKEN as fallback
export NPM_TOKEN="npm_xxxxxxxxxxxxx"
pantry publish
```

### Testing OIDC Locally

OIDC only works in CI/CD environments. To test locally:

```bash
# Use dry-run to test configuration
pantry publish --dry-run

# Use token auth for local testing
export NPM_TOKEN="your_token"
pantry publish --no-oidc
```

## Security Best Practices

### 1. Use GitHub Environments

Add an environment for additional protection:

```yaml
jobs:
  publish:
    runs-on: ubuntu-latest
    environment: npm-production  # Requires manual approval

    permissions:
      id-token: write
      contents: read
```

Configure environment protection rules:

- Required reviewers
- Wait timer
- Branch restrictions

### 2. Restrict Allowed Refs

When configuring trusted publisher on npm, specify allowed refs:

- `refs/heads/main` - Only from main branch
- `refs/tags/v_` - Only from version tags
- `refs/heads/release/_` - Only from release branches

### 3. Use Workflow Environments

Specify the environment name in your trusted publisher configuration to ensure publishing only happens from approved environments.

### 4. Monitor Provenance

Regularly check your package's provenance to verify all publishes are legitimate:

```bash
npm view @myorg/my-package versions --json | jq '.[].provenance'
```

### 5. Audit OIDC Claims

Review the OIDC claims logged during publish to ensure they match expectations:

```
OIDC Claims:
  Issuer: https://token.actions.githubusercontent.com
  Subject: repo:myorg/my-repo:ref:refs/heads/main
  Repository: myorg/my-repo
  Ref: refs/heads/main
  SHA: abc123...
```

## Advanced Usage

### Custom OIDC Provider

If using a custom OIDC provider:

```bash
# Set custom OIDC token
export CUSTOM_OIDC_TOKEN="eyJ..."
pantry publish
```

### Disable Provenance

```bash
# Publish without generating provenance
pantry publish --no-provenance
```

### Custom Provenance Format

Provenance is generated in SLSA v0.2 format. Future versions will support custom formats.

## GitLab CI Example

```yaml
publish:
  stage: deploy
  image: alpine:latest
  script:

    - apk add --no-cache curl bash
    - curl -fsSL https://pantry.sh/install.sh | bash
    - pantry publish

  only:

    - tags

# GitLab automatically provides CI_JOB_JWT_V2
```

## Migration from Token Authentication

### Before (using NPM_TOKEN)

```yaml

- name: Publish

  run: npm publish
  env:
    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### After (using OIDC)

```yaml
permissions:
  id-token: write
  contents: read

steps:

  - name: Publish

    run: pantry publish
# No secrets needed
```

## Reference

### Environment Variables

- `ACTIONS_ID_TOKEN_REQUEST_URL` - GitHub Actions OIDC token URL
- `ACTIONS_ID_TOKEN_REQUEST_TOKEN` - GitHub Actions request token
- `CI_JOB_JWT_V2` - GitLab CI OIDC token
- `BITBUCKET_STEP_OIDC_TOKEN` - Bitbucket Pipelines token
- `CIRCLE_OIDC_TOKEN` - CircleCI token
- `NPM_TOKEN` - Fallback token (optional)

### Publish Command Options

```bash
pantry publish [options]

Options:
  --registry <url>      Registry URL
  --access <public|restricted>  Package access level
  --tag <tag>           Distribution tag
  --dry-run            Test without publishing
  --no-oidc            Disable OIDC, use token auth
  --no-provenance      Skip provenance generation
```

### Package Configuration

```json
{
  "publishConfig": {
    "registry": "https://registry.npmjs.org",
    "access": "public",
    "tag": "latest"
  }
}
```

## Resources

- [npm Trusted Publishers Documentation](https://docs.npmjs.com/trusted-publishers/)
- [GitHub Actions OIDC](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)
- [SLSA Provenance](https://slsa.dev/provenance/)
- [Pantry OIDC Implementation](./OIDC_IMPLEMENTATION_SUMMARY.md)

## Support

For issues or questions:

- GitHub Issues: [pantry/issues](https://github.com/pantry-dev/pantry/issues)
- Documentation: [docs.pantry.dev](https://docs.pantry.dev)
- Discord: [pantry.dev/discord](https://pantry.dev/discord)
