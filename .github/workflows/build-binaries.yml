name: Precompile Binaries

on:
  push:
    branches: [main, develop]
    paths:
      - .github/workflows/build-binaries.yml
      - 'build-configs/**'
  schedule:
    # Build weekly on Sunday at 2 AM UTC to get latest dependencies
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      php_version:
        description: PHP Version to build
        required: false
        default: 8.4.11
        type: string
      force_rebuild:
        description: Force rebuild even if binary exists
        required: false
        default: false
        type: boolean

env:
  REGISTRY_URL: ghcr.io
  REGISTRY_USERNAME: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # First job: Get dynamic PHP versions from ts-pkgx
  get-php-versions:
    runs-on: ubuntu-latest
    outputs:
      php_versions: ${{ steps.get-versions.outputs.php_versions }}
    steps:
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Get PHP versions from ts-pkgx
        id: get-versions
        run: |
          # Get dynamic PHP versions using published ts-pkgx package
          PHP_VERSIONS=$(bunx ts-pkgx get-php-versions)
          echo "php_versions=$PHP_VERSIONS" >> $GITHUB_OUTPUT
          echo "ðŸ” Dynamic PHP versions: $PHP_VERSIONS"

  # Matrix strategy for building across different platforms and configurations
  build-matrix:
    needs: get-php-versions
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, macos-13] # Include Intel Mac
        php_version: ${{ fromJSON(needs.get-php-versions.outputs.php_versions) }}
        config: [laravel-mysql, laravel-postgres, laravel-sqlite, api-only, enterprise, wordpress]
        include:
          # Add Windows later if needed
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: macos-13
            platform: darwin
            arch: x86_64
        exclude:
          # Skip some combinations to reduce build time
          - os: macos-13
            config: api-only
          # WordPress mainly used on Linux
          - os: macos-13
            config: wordpress

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          echo "Building PHP ${{ matrix.php_version }} for ${{ matrix.platform }}-${{ matrix.arch }}"
          echo "Configuration: ${{ matrix.config }}"
          echo "BINARY_NAME=php-${{ matrix.php_version }}-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.config }}" >> $GITHUB_ENV
          echo "BUILD_DIR=${{ github.workspace }}/build" >> $GITHUB_ENV
          echo "OUTPUT_DIR=${{ github.workspace }}/binaries" >> $GITHUB_ENV

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Use cached node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            node-modules-

      - name: Install Dependencies
        run: bun install

      - name: Install build dependencies (Ubuntu)
        if: matrix.platform == 'linux'
        run: |
          # Install PHP dependencies via Launchpad with enhanced debugging
          echo "ðŸ”§ Installing PHP dependencies via Launchpad..."
          echo "ðŸ” Debug info:"
          echo "  - Platform: linux"
          echo "  - Architecture: $(uname -m)"
          echo "  - Network connectivity test:"
          # Temporarily modify PATH to prioritize system binaries over launchpad binaries
          export PATH="/usr/bin:/usr/local/bin:/bin:$PATH"
          curl -I --connect-timeout 10 https://dist.pkgx.dev/ || echo "  âš ï¸ Network connectivity issues detected"

          # Set environment variables for better debugging
          export LAUNCHPAD_DEBUG=1
          export LAUNCHPAD_VERBOSE=1

          ./launchpad install php --deps-only --verbose

          # Alternative: Use apt-get for manual dependency installation
          # sudo apt-get update
          # sudo apt-get install -y \
          #   build-essential \
          #   autoconf \
          #   automake \
          #   libtool \
          #   pkg-config \
          #   bison \
          #   re2c \
          #   libxml2-dev \
          #   libssl-dev \
          #   libcurl4-openssl-dev \
          #   libpng-dev \
          #   libjpeg-dev \
          #   libfreetype6-dev \
          #   libonig-dev \
          #   libzip-dev \
          #   libsqlite3-dev \
          #   libpq-dev \
          #   libreadline-dev \
          #   libbz2-dev \
          #   libgmp-dev \
          #   libldap2-dev \
          #   libsasl2-dev \
          #   libxslt1-dev \
          #   libicu-dev \
          #   libsodium-dev \
          #   zlib1g-dev

      - name: Install build dependencies (macOS)
        if: matrix.platform == 'darwin'
        run: |
          # Install PHP dependencies via Launchpad with enhanced debugging
          echo "ðŸ”§ Installing PHP dependencies via Launchpad..."
          echo "ðŸ” Debug info:"
          echo "  - Platform: darwin"
          echo "  - Architecture: $(uname -m)"
          echo "  - Network connectivity test:"
          # Temporarily modify PATH to prioritize system binaries over launchpad binaries
          export PATH="/usr/bin:/usr/local/bin:/bin:$PATH"
          curl -I --connect-timeout 10 https://dist.pkgx.dev/ || echo "  âš ï¸ Network connectivity issues detected"

          # Set environment variables for better debugging
          export LAUNCHPAD_DEBUG=1
          export LAUNCHPAD_VERBOSE=1

          ./launchpad install php --deps-only --verbose

          # Alternative: Use Homebrew for manual dependency installation
          # brew install \
          #   autoconf \
          #   automake \
          #   libtool \
          #   pkg-config \
          #   bison \
          #   re2c \
          #   libxml2 \
          #   openssl@3 \
          #   curl \
          #   libpng \
          #   jpeg \
          #   freetype \
          #   oniguruma \
          #   libzip \
          #   postgresql \
          #   readline \
          #   bzip2 \
          #   gmp \
          #   openldap \
          #   libxslt \
          #   icu4c \
          #   libsodium \
          #   zlib \
          #   libiconv

      - name: Create build configuration
        run: |
          mkdir -p ${{ env.BUILD_DIR }} ${{ env.OUTPUT_DIR }}

                    # Create configuration based on matrix config
          case "${{ matrix.config }}" in
            "laravel-mysql")
              EXTENSIONS="--enable-cli --enable-fpm --enable-mbstring --enable-opcache --enable-intl --enable-exif --enable-bcmath --with-pdo-mysql --with-mysqli --enable-curl --with-openssl --enable-gd --with-zip --with-readline --enable-libxml --with-zlib"
              ;;
            "laravel-postgres")
              EXTENSIONS="--enable-cli --enable-fpm --enable-mbstring --enable-opcache --enable-intl --enable-exif --enable-bcmath --with-pdo-pgsql --with-pgsql --enable-curl --with-openssl --enable-gd --with-zip --with-readline --enable-libxml --with-zlib"
              ;;
            "laravel-sqlite")
              EXTENSIONS="--enable-cli --enable-fpm --enable-mbstring --enable-opcache --enable-intl --enable-exif --enable-bcmath --with-pdo-sqlite --with-sqlite3 --with-curl --with-openssl --enable-gd --with-zip --with-readline --with-libxml --with-zlib"
              ;;
            "api-only")
              EXTENSIONS="--enable-cli --enable-fpm --enable-mbstring --enable-opcache --enable-bcmath --with-pdo-mysql --with-mysqli --with-curl --with-openssl --with-zip --with-libxml --with-zlib"
              ;;
            "enterprise")
              EXTENSIONS="--enable-cli --enable-fpm --enable-mbstring --enable-opcache --enable-intl --enable-exif --enable-bcmath --with-pdo-mysql --with-pdo-pgsql --with-pdo-sqlite --with-mysqli --with-pgsql --with-sqlite3 --with-curl --with-openssl --enable-gd --enable-soap --enable-sockets --with-zip --with-bz2 --with-readline --with-libxml --with-zlib --enable-pcntl --enable-posix --with-gettext --with-gmp --with-ldap --with-xsl --with-sodium"
              ;;
            "wordpress")
              EXTENSIONS="--enable-cli --enable-fpm --enable-mbstring --enable-opcache --enable-exif --with-pdo-mysql --with-mysqli --with-curl --with-openssl --enable-gd --with-zip --with-libxml --with-zlib"
              ;;
          esac

          echo "CONFIGURE_EXTENSIONS=$EXTENSIONS" >> $GITHUB_ENV

      - name: Set macOS specific paths
        if: matrix.platform == 'darwin'
        run: |
          # Set paths for Homebrew dependencies
          echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig:$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix libxml2)/lib/pkgconfig:$(brew --prefix icu4c)/lib/pkgconfig" >> $GITHUB_ENV
          echo "PATH=$(brew --prefix bison)/bin:$(brew --prefix)/bin:$PATH" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix)/lib -L$(brew --prefix openssl@3)/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix)/include -I$(brew --prefix openssl@3)/include" >> $GITHUB_ENV

      - name: Download and extract PHP source
        run: |
          cd ${{ env.BUILD_DIR }}
          # Temporarily modify PATH to prioritize system binaries over launchpad binaries
          # This prevents conflicts with launchpad-installed binaries that may have library dependencies
          export PATH="/usr/bin:/usr/local/bin:/bin:$PATH"
          # Use system curl instead of launchpad curl to avoid library conflicts
          curl -fsSL "https://www.php.net/distributions/php-${{ matrix.php_version }}.tar.gz" -o php.tar.gz
          tar -xzf php.tar.gz
          cd php-${{ matrix.php_version }}
          echo "PHP_SOURCE_DIR=${{ env.BUILD_DIR }}/php-${{ matrix.php_version }}" >> $GITHUB_ENV

      - name: Configure PHP build
        run: |
          cd ${{ env.PHP_SOURCE_DIR }}

          # Create installation directory
          INSTALL_PREFIX="${{ env.OUTPUT_DIR }}/${{ env.BINARY_NAME }}"
          mkdir -p "$INSTALL_PREFIX"

          # Set up launchpad build environment
          echo "Setting up launchpad build environment..."
          source "$HOME/.local/share/launchpad/global/build-env.sh"

          # Configure with platform-specific options
          if [[ "${{ matrix.platform }}" == "darwin" ]]; then
            # On macOS, point to Homebrew iconv installation
            EXTRA_CONFIG="--with-iconv=$(brew --prefix libiconv)"
          else
            # On Linux, use launchpad-installed iconv and readline
            # Find the launchpad iconv installation
            LAUNCHPAD_ICONV_DIR="$HOME/.local/share/launchpad/global/gnu.org/libiconv"
            if [[ -d "$LAUNCHPAD_ICONV_DIR" ]]; then
              # Find the latest version
              ICONV_VERSION=$(ls "$LAUNCHPAD_ICONV_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$ICONV_VERSION" ]]; then
                ICONV_PATH="$LAUNCHPAD_ICONV_DIR/$ICONV_VERSION"
                echo "Found launchpad iconv at: $ICONV_PATH"
                EXTRA_CONFIG="--with-iconv=$ICONV_PATH"
              else
                echo "No iconv version found in $LAUNCHPAD_ICONV_DIR"
                EXTRA_CONFIG="--with-iconv"
              fi
            else
              echo "Launchpad iconv not found, using system iconv"
              EXTRA_CONFIG="--with-iconv"
            fi

            # Find the launchpad readline installation
            LAUNCHPAD_READLINE_DIR="$HOME/.local/share/launchpad/global/gnu.org/readline"
            if [[ -d "$LAUNCHPAD_READLINE_DIR" ]]; then
              # Find the latest version
              READLINE_VERSION=$(ls "$LAUNCHPAD_READLINE_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$READLINE_VERSION" ]]; then
                READLINE_PATH="$LAUNCHPAD_READLINE_DIR/$READLINE_VERSION"
                echo "Found launchpad readline at: $READLINE_PATH"
                EXTRA_CONFIG="$EXTRA_CONFIG --with-readline=$READLINE_PATH"
              else
                echo "No readline version found in $LAUNCHPAD_READLINE_DIR"
              fi
            else
              echo "Launchpad readline not found, using system readline"
            fi

            # Find the launchpad bzip2 installation
            LAUNCHPAD_BZIP2_DIR="$HOME/.local/share/launchpad/global/sourceware.org/bzip2"
            if [[ -d "$LAUNCHPAD_BZIP2_DIR" ]]; then
              # Find the latest version
              BZIP2_VERSION=$(ls "$LAUNCHPAD_BZIP2_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$BZIP2_VERSION" ]]; then
                BZIP2_PATH="$LAUNCHPAD_BZIP2_DIR/$BZIP2_VERSION"
                echo "Found launchpad bzip2 at: $BZIP2_PATH"

                                # Check multiple possible locations for bzlib.h
                BZLIB_FOUND=false
                for include_path in "$BZIP2_PATH/include/bzlib.h" "$BZIP2_PATH/include/bzip2/bzlib.h" "$BZIP2_PATH/bzlib.h"; do
                  if [[ -f "$include_path" ]]; then
                    echo "âœ“ bzlib.h found at $include_path"
                    # Only add if the path is not empty
                    if [[ -n "$BZIP2_PATH" ]]; then
                      EXTRA_CONFIG="$EXTRA_CONFIG --with-bz2=$BZIP2_PATH"
                      echo "Added --with-bz2=$BZIP2_PATH"
                    else
                      echo "âš ï¸  BZIP2_PATH is empty, skipping --with-bz2 option"
                    fi
                    BZLIB_FOUND=true
                    break
                  fi
                done

                if [[ "$BZLIB_FOUND" == "false" ]]; then
                  echo "âš ï¸  bzlib.h not found in expected locations:"
                  echo "   - $BZIP2_PATH/include/bzlib.h"
                  echo "   - $BZIP2_PATH/include/bzip2/bzlib.h"
                  echo "   - $BZIP2_PATH/bzlib.h"
                  echo "   Checking what files exist in include directory:"
                  if [[ -d "$BZIP2_PATH/include" ]]; then
                    ls -la "$BZIP2_PATH/include/" || echo "Could not list include directory"
                  fi
                  echo "   Disabling bzip2 support"
                  EXTRA_CONFIG="$EXTRA_CONFIG --disable-bz2"
                fi
              else
                echo "No bzip2 version found in $LAUNCHPAD_BZIP2_DIR"
                echo "Disabling bzip2 support"
                EXTRA_CONFIG="$EXTRA_CONFIG --disable-bz2"
              fi
            else
              echo "Launchpad bzip2 not found, checking system bzip2"
              # Check if system bzip2 is available
              if [[ -f "/usr/include/bzlib.h" ]] || [[ -f "/usr/local/include/bzlib.h" ]]; then
                echo "âœ“ System bzip2 headers found"
              else
                echo "âš ï¸  No bzip2 headers found, disabling bzip2 support"
                EXTRA_CONFIG="$EXTRA_CONFIG --disable-bz2"
              fi
            fi

                        # Check libzip compatibility and handle zip extension
            LAUNCHPAD_LIBZIP_DIR="$HOME/.local/share/launchpad/global/libzip.org"
            if [[ -d "$LAUNCHPAD_LIBZIP_DIR" ]]; then
              # Find the latest version
              LIBZIP_VERSION=$(ls "$LAUNCHPAD_LIBZIP_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$LIBZIP_VERSION" ]]; then
                LIBZIP_PATH="$LAUNCHPAD_LIBZIP_DIR/$LIBZIP_VERSION"
                echo "Found launchpad libzip at: $LIBZIP_PATH"

                # Check if this libzip version is compatible with PHP 8.4
                # PHP 8.4 requires libzip >= 1.8.0 for full compatibility
                if [[ "$LIBZIP_VERSION" =~ v1\.([0-9]+)\.([0-9]+) ]]; then
                  MAJOR_VERSION="${BASH_REMATCH[1]}"
                  MINOR_VERSION="${BASH_REMATCH[2]}"
                  if [[ "$MAJOR_VERSION" -ge 1 && "$MINOR_VERSION" -ge 8 ]]; then
                    echo "âœ“ libzip version $LIBZIP_VERSION is compatible with PHP 8.4"
                    EXTRA_CONFIG="$EXTRA_CONFIG --with-libzip=$LIBZIP_PATH"
                  else
                    echo "âš ï¸  libzip version $LIBZIP_VERSION may not be fully compatible with PHP 8.4"
                    echo "   Disabling zip extension to avoid build issues"
                    EXTRA_CONFIG="$EXTRA_CONFIG --disable-zip"
                  fi
                elif [[ "$LIBZIP_VERSION" =~ v1\.([0-9]+) ]]; then
                  # Handle version format like v1.9.2
                  MAJOR_VERSION="${BASH_REMATCH[1]}"
                  if [[ "$MAJOR_VERSION" -ge 1 ]]; then
                    echo "âœ“ libzip version $LIBZIP_VERSION is compatible with PHP 8.4"
                    EXTRA_CONFIG="$EXTRA_CONFIG --with-libzip=$LIBZIP_PATH"
                  else
                    echo "âš ï¸  libzip version $LIBZIP_VERSION may not be fully compatible with PHP 8.4"
                    echo "   Disabling zip extension to avoid build issues"
                    EXTRA_CONFIG="$EXTRA_CONFIG --disable-zip"
                  fi
                else
                  echo "âš ï¸  Could not determine libzip version, disabling zip extension"
                  EXTRA_CONFIG="$EXTRA_CONFIG --disable-zip"
                fi
              else
                echo "No libzip version found in $LAUNCHPAD_LIBZIP_DIR"
                echo "Disabling zip extension"
                EXTRA_CONFIG="$EXTRA_CONFIG --disable-zip"
              fi
            else
              echo "Launchpad libzip not found, checking system libzip"
              # Check system libzip version
              if pkg-config --exists libzip; then
                LIBZIP_VERSION=$(pkg-config --modversion libzip)
                echo "System libzip version: $LIBZIP_VERSION"
                # If system libzip is too old, disable zip extension
                if [[ "$LIBZIP_VERSION" =~ ^([0-9]+)\.([0-9]+) ]]; then
                  MAJOR_VERSION="${BASH_REMATCH[1]}"
                  MINOR_VERSION="${BASH_REMATCH[2]}"
                  if [[ "$MAJOR_VERSION" -ge 1 && "$MINOR_VERSION" -ge 8 ]]; then
                    echo "âœ“ System libzip version $LIBZIP_VERSION is compatible"
                  else
                    echo "âš ï¸  System libzip version $LIBZIP_VERSION is too old, disabling zip extension"
                    EXTRA_CONFIG="$EXTRA_CONFIG --disable-zip"
                  fi
                else
                  echo "âš ï¸  Could not determine system libzip version, disabling zip extension"
                  EXTRA_CONFIG="$EXTRA_CONFIG --disable-zip"
                fi
              else
                echo "No system libzip found, disabling zip extension"
                EXTRA_CONFIG="$EXTRA_CONFIG --disable-zip"
              fi
            fi

            # Find launchpad-installed GMP for bcmath extension
            LAUNCHPAD_GMP_DIR="$HOME/.local/share/launchpad/global/gnu.org/gmp"
            if [[ -d "$LAUNCHPAD_GMP_DIR" ]]; then
              GMP_VERSION=$(ls "$LAUNCHPAD_GMP_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$GMP_VERSION" ]]; then
                GMP_PATH="$LAUNCHPAD_GMP_DIR/$GMP_VERSION"
                echo "Found launchpad GMP at: $GMP_PATH"
                EXTRA_CONFIG="$EXTRA_CONFIG --with-gmp=$GMP_PATH"
              fi
            fi

            # Find launchpad-installed libsodium for sodium extension
            LAUNCHPAD_SODIUM_DIR="$HOME/.local/share/launchpad/global/libsodium.org"
            if [[ -d "$LAUNCHPAD_SODIUM_DIR" ]]; then
              SODIUM_VERSION=$(ls "$LAUNCHPAD_SODIUM_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$SODIUM_VERSION" ]]; then
                SODIUM_PATH="$LAUNCHPAD_SODIUM_DIR/$SODIUM_VERSION"
                echo "Found launchpad libsodium at: $SODIUM_PATH"
                EXTRA_CONFIG="$EXTRA_CONFIG --with-sodium=$SODIUM_PATH"
              fi
            fi

            # Find launchpad-installed oniguruma for mbstring extension
            LAUNCHPAD_ONIGURUMA_DIR="$HOME/.local/share/launchpad/global/github.com/kkos/oniguruma"
            if [[ -d "$LAUNCHPAD_ONIGURUMA_DIR" ]]; then
              ONIGURUMA_VERSION=$(ls "$LAUNCHPAD_ONIGURUMA_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$ONIGURUMA_VERSION" ]]; then
                ONIGURUMA_PATH="$LAUNCHPAD_ONIGURUMA_DIR/$ONIGURUMA_VERSION"
                echo "Found launchpad oniguruma at: $ONIGURUMA_PATH"
                EXTRA_CONFIG="$EXTRA_CONFIG --with-onig=$ONIGURUMA_PATH"
              fi
            fi

            # Find launchpad-installed libxml2 for XML extension
            LAUNCHPAD_LIBXML2_DIR="$HOME/.local/share/launchpad/global/gnome.org/libxml2"
            if [[ -d "$LAUNCHPAD_LIBXML2_DIR" ]]; then
              LIBXML2_VERSION=$(ls "$LAUNCHPAD_LIBXML2_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$LIBXML2_VERSION" ]]; then
                LIBXML2_PATH="$LAUNCHPAD_LIBXML2_DIR/$LIBXML2_VERSION"
                echo "Found launchpad libxml2 at: $LIBXML2_PATH"
                EXTRA_CONFIG="$EXTRA_CONFIG --with-libxml-dir=$LIBXML2_PATH"
              fi
            fi

            # Find launchpad-installed libxslt for XSLT extension
            LAUNCHPAD_LIBXSLT_DIR="$HOME/.local/share/launchpad/global/gnome.org/libxslt"
            if [[ -d "$LAUNCHPAD_LIBXSLT_DIR" ]]; then
              LIBXSLT_VERSION=$(ls "$LAUNCHPAD_LIBXSLT_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$LIBXSLT_VERSION" ]]; then
                LIBXSLT_PATH="$LAUNCHPAD_LIBXSLT_DIR/$LIBXSLT_VERSION"
                echo "Found launchpad libxslt at: $LIBXSLT_PATH"
                EXTRA_CONFIG="$EXTRA_CONFIG --with-xsl=$LIBXSLT_PATH"
              fi
            fi

            # Find launchpad-installed openldap for LDAP extension
            LAUNCHPAD_OPENLDAP_DIR="$HOME/.local/share/launchpad/global/openldap.org"
            if [[ -d "$LAUNCHPAD_OPENLDAP_DIR" ]]; then
              OPENLDAP_VERSION=$(ls "$LAUNCHPAD_OPENLDAP_DIR" | grep "^v" | sort -V | tail -1)
              if [[ -n "$OPENLDAP_VERSION" ]]; then
                OPENLDAP_PATH="$LAUNCHPAD_OPENLDAP_DIR/$OPENLDAP_VERSION"
                echo "Found launchpad openldap at: $OPENLDAP_PATH"
                EXTRA_CONFIG="$EXTRA_CONFIG --with-ldap=$OPENLDAP_PATH"
              fi
            fi

            # Clean up EXTRA_CONFIG to remove any duplicate options and validate
            echo "Cleaning up EXTRA_CONFIG to remove duplicates..."
            # Remove duplicate --with-* options and validate
            CLEANED_EXTRA_CONFIG=""
            for option in $EXTRA_CONFIG; do
              # Skip empty options
              if [[ -z "$option" ]]; then
                echo "Skipping empty option"
                continue
              fi

              if [[ "$option" =~ ^--with- ]]; then
                # Extract the option name (e.g., --with-bz2, --with-iconv)
                option_name=$(echo "$option" | cut -d'=' -f1)
                # Only add if not already present and has a value
                if [[ "$CLEANED_EXTRA_CONFIG" != *"$option_name"* ]] && [[ "$option" =~ = ]]; then
                  # Validate that the path exists
                  option_path=$(echo "$option" | cut -d'=' -f2-)
                  if [[ -d "$option_path" ]]; then
                    CLEANED_EXTRA_CONFIG="$CLEANED_EXTRA_CONFIG $option"
                    echo "Added valid option: $option"
                  else
                    echo "Skipping invalid path: $option (path does not exist: $option_path)"
                  fi
                else
                  echo "Removing duplicate or invalid option: $option"
                fi
              else
                CLEANED_EXTRA_CONFIG="$CLEANED_EXTRA_CONFIG $option"
              fi
            done
            EXTRA_CONFIG="$CLEANED_EXTRA_CONFIG"
            echo "Cleaned EXTRA_CONFIG: $EXTRA_CONFIG"

            # Final validation: ensure no empty or problematic options
            FINAL_EXTRA_CONFIG=""
            for option in $EXTRA_CONFIG; do
              # Skip empty or whitespace-only options
              if [[ -z "${option// }" ]]; then
                echo "Removing empty option"
                continue
              fi
              # Skip options that might cause issues
              if [[ "$option" =~ ^--with-[^=]+$ ]]; then
                echo "Removing option without value: $option"
                continue
              fi
              FINAL_EXTRA_CONFIG="$FINAL_EXTRA_CONFIG $option"
            done
            EXTRA_CONFIG="$FINAL_EXTRA_CONFIG"
            echo "Final EXTRA_CONFIG: $EXTRA_CONFIG"

            # Final check: ensure no empty or problematic options remain
            echo "Final validation of EXTRA_CONFIG:"
            FINAL_VALIDATED_CONFIG=""
            for option in $EXTRA_CONFIG; do
              # Skip completely empty options
              if [[ -z "$option" ]]; then
                echo "Removing empty option"
                continue
              fi
              # Skip options that are just whitespace
              if [[ -z "${option// }" ]]; then
                echo "Removing whitespace-only option"
                continue
              fi
              # Skip options that might cause issues (like --with-bz2 without value)
              if [[ "$option" =~ ^--with-[^=]+$ ]]; then
                echo "Removing option without value: $option"
                continue
              fi
              FINAL_VALIDATED_CONFIG="$FINAL_VALIDATED_CONFIG $option"
            done
            EXTRA_CONFIG="$FINAL_VALIDATED_CONFIG"
            echo "Final validated EXTRA_CONFIG: $EXTRA_CONFIG"
          fi

          echo "Configuring PHP with:"
          echo "  Extensions: ${{ env.CONFIGURE_EXTENSIONS }}"
          echo "  Prefix: $INSTALL_PREFIX"
          echo "  Extra config: $EXTRA_CONFIG"
          echo "  PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
          echo "  LD_LIBRARY_PATH: $LD_LIBRARY_PATH"

          # Debug: Show the final configure command
          echo "Final configure command will be:"
          echo "./configure --prefix=\"$INSTALL_PREFIX\" --disable-debug --enable-shared --with-pic ${{ env.CONFIGURE_EXTENSIONS }} $EXTRA_CONFIG $CURL_CONFIG"

          # Debug: Show each argument separately
          echo "Debug: Breaking down configure arguments:"
          echo "  --prefix=\"$INSTALL_PREFIX\""
          echo "  --disable-debug"
          echo "  --enable-shared"
          echo "  --with-pic"
          echo "  CONFIGURE_EXTENSIONS: ${{ env.CONFIGURE_EXTENSIONS }}"
          echo "  EXTRA_CONFIG: $EXTRA_CONFIG"
          echo "  CURL_CONFIG: $CURL_CONFIG"

          # Debug: Show each EXTRA_CONFIG option separately
          echo "Debug: EXTRA_CONFIG options:"
          for option in $EXTRA_CONFIG; do
            echo "  '$option'"
          done

          # Debug: Show available pkg-config files
          echo "Available pkg-config files:"
          pkg-config --list-all | grep -i curl || echo "No curl pkg-config found"
          echo "libcurl pkg-config info:"
          pkg-config --exists libcurl && pkg-config --modversion libcurl || echo "libcurl not found via pkg-config"

          # Show all available pkg-config files for debugging
          echo "All available pkg-config files:"
          pkg-config --list-all | head -20
          echo "... (showing first 20)"

          # Check if libcurl is found via pkg-config
          if pkg-config --exists libcurl; then
            echo "libcurl found via pkg-config"
            CURL_CONFIG=""
          else
            echo "libcurl not found via pkg-config, using manual configuration"
            CURL_CONFIG="--with-curl=$HOME/.local/share/launchpad/global/curl.se/v8.15.0"
          fi

          # Check for other common libraries
          echo "Checking for other required libraries:"
          pkg-config --exists openssl && echo "âœ“ openssl found" || echo "âœ— openssl not found"
          pkg-config --exists zlib && echo "âœ“ zlib found" || echo "âœ— zlib not found"
          pkg-config --exists libxml-2.0 && echo "âœ“ libxml-2.0 found" || echo "âœ— libxml-2.0 not found"
          pkg-config --exists sqlite3 && echo "âœ“ sqlite3 found" || echo "âœ— sqlite3 not found"

          # Ensure launchpad iconv, readline, and bzip2 are properly linked and available
          if [[ "${{ matrix.platform }}" != "darwin" ]]; then
            echo "Ensuring launchpad iconv, readline, and bzip2 are properly configured..."
            # Check if launchpad iconv is available and working
            if command -v iconv >/dev/null 2>&1; then
              echo "âœ“ iconv found in PATH"
              iconv --version 2>/dev/null | head -1 || echo "iconv version check failed"
            else
              echo "âš ï¸  iconv not found in PATH"
            fi

            # Check if readline headers are available
            if [[ -f "/usr/include/readline/readline.h" ]] || [[ -f "/usr/local/include/readline/readline.h" ]]; then
              echo "âœ“ readline.h found in system include paths"
            else
              echo "âš ï¸  readline.h not found in system include paths"
              # Check if we can find it in launchpad paths
              LAUNCHPAD_READLINE_DIR="$HOME/.local/share/launchpad/global/gnu.org/readline"
              if [[ -d "$LAUNCHPAD_READLINE_DIR" ]]; then
                READLINE_VERSION=$(ls "$LAUNCHPAD_READLINE_DIR" | grep "^v" | sort -V | tail -1)
                if [[ -n "$READLINE_VERSION" ]]; then
                  READLINE_INCLUDE="$LAUNCHPAD_READLINE_DIR/$READLINE_VERSION/include"
                  if [[ -f "$READLINE_INCLUDE/readline/readline.h" ]]; then
                    echo "âœ“ readline.h found in launchpad: $READLINE_INCLUDE/readline/readline.h"
                  else
                    echo "âš ï¸  readline.h not found in launchpad include path"
                  fi
                fi
              fi
            fi

            # Check if bzip2 headers are available
            if [[ -f "/usr/include/bzlib.h" ]] || [[ -f "/usr/local/include/bzlib.h" ]]; then
              echo "âœ“ bzlib.h found in system include paths"
            else
              echo "âš ï¸  bzlib.h not found in system include paths"
              # Check if we can find it in launchpad paths
              LAUNCHPAD_BZIP2_DIR="$HOME/.local/share/launchpad/global/sourceware.org/bzip2"
              if [[ -d "$LAUNCHPAD_BZIP2_DIR" ]]; then
                BZIP2_VERSION=$(ls "$LAUNCHPAD_BZIP2_DIR" | grep "^v" | sort -V | tail -1)
                if [[ -n "$BZIP2_VERSION" ]]; then
                  BZIP2_INCLUDE="$LAUNCHPAD_BZIP2_DIR/$BZIP2_VERSION/include"
                  if [[ -f "$BZIP2_INCLUDE/bzlib.h" ]]; then
                    echo "âœ“ bzlib.h found in launchpad: $BZIP2_INCLUDE/bzlib.h"
                  else
                    echo "âš ï¸  bzlib.h not found in launchpad include path"
                  fi
                fi
              fi
            fi

            # Check if libzip headers are available
            if [[ -f "/usr/include/zip.h" ]] || [[ -f "/usr/local/include/zip.h" ]]; then
              echo "âœ“ zip.h found in system include paths"
            else
              echo "âš ï¸  zip.h not found in system include paths"
              # Check if we can find it in launchpad paths
              LAUNCHPAD_LIBZIP_DIR="$HOME/.local/share/launchpad/global/libzip.org"
              if [[ -d "$LAUNCHPAD_LIBZIP_DIR" ]]; then
                LIBZIP_VERSION=$(ls "$LAUNCHPAD_LIBZIP_DIR" | grep "^v" | sort -V | tail -1)
                if [[ -n "$LIBZIP_VERSION" ]]; then
                  LIBZIP_INCLUDE="$LAUNCHPAD_LIBZIP_DIR/$LIBZIP_VERSION/include"
                  if [[ -f "$LIBZIP_INCLUDE/zip.h" ]]; then
                    echo "âœ“ zip.h found in launchpad: $LIBZIP_INCLUDE/zip.h"
                  else
                    echo "âš ï¸  zip.h not found in launchpad include path"
                  fi
                fi
              fi
            fi

            # Check if GMP headers are available
            if [[ -f "/usr/include/gmp.h" ]] || [[ -f "/usr/local/include/gmp.h" ]]; then
              echo "âœ“ gmp.h found in system include paths"
            else
              echo "âš ï¸  gmp.h not found in system include paths"
              # Check if we can find it in launchpad paths
              LAUNCHPAD_GMP_DIR="$HOME/.local/share/launchpad/global/gnu.org/gmp"
              if [[ -d "$LAUNCHPAD_GMP_DIR" ]]; then
                GMP_VERSION=$(ls "$LAUNCHPAD_GMP_DIR" | grep "^v" | sort -V | tail -1)
                if [[ -n "$GMP_VERSION" ]]; then
                  GMP_INCLUDE="$LAUNCHPAD_GMP_DIR/$GMP_VERSION/include"
                  if [[ -f "$GMP_INCLUDE/gmp.h" ]]; then
                    echo "âœ“ gmp.h found in launchpad: $GMP_INCLUDE/gmp.h"
                  else
                    echo "âš ï¸  gmp.h not found in launchpad include path"
                  fi
                fi
              fi
            fi

            # Check if libxml2 headers are available
            if [[ -f "/usr/include/libxml2/libxml/xmlversion.h" ]] || [[ -f "/usr/local/include/libxml2/libxml/xmlversion.h" ]]; then
              echo "âœ“ libxml2 headers found in system include paths"
            else
              echo "âš ï¸  libxml2 headers not found in system include paths"
              # Check if we can find it in launchpad paths
              LAUNCHPAD_LIBXML2_DIR="$HOME/.local/share/launchpad/global/gnome.org/libxml2"
              if [[ -d "$LAUNCHPAD_LIBXML2_DIR" ]]; then
                LIBXML2_VERSION=$(ls "$LAUNCHPAD_LIBXML2_DIR" | grep "^v" | sort -V | tail -1)
                if [[ -n "$LIBXML2_VERSION" ]]; then
                  LIBXML2_INCLUDE="$LAUNCHPAD_LIBXML2_DIR/$LIBXML2_VERSION/include"
                  if [[ -f "$LIBXML2_INCLUDE/libxml2/libxml/xmlversion.h" ]]; then
                    echo "âœ“ libxml2 headers found in launchpad: $LIBXML2_INCLUDE/libxml2/libxml/xmlversion.h"
                  else
                    echo "âš ï¸  libxml2 headers not found in launchpad include path"
                  fi
                fi
              fi
            fi
          fi

          ./configure \
            --prefix="$INSTALL_PREFIX" \
            --disable-debug \
            --enable-shared \
            --with-pic \
            ${{ env.CONFIGURE_EXTENSIONS }} \
            $EXTRA_CONFIG \
            $CURL_CONFIG

      - name: Build PHP
        run: |
          cd ${{ env.PHP_SOURCE_DIR }}

          # Set up launchpad build environment for compilation
          source "$HOME/.local/share/launchpad/global/build-env.sh"

          # Use all available CPU cores for faster builds
          if [[ "${{ matrix.platform }}" == "darwin" ]]; then
            JOBS=$(sysctl -n hw.ncpu)
          else
            JOBS=$(nproc)
          fi

          echo "Building PHP with $JOBS parallel jobs"
          make -j$JOBS

      - name: Install PHP
        run: |
          cd ${{ env.PHP_SOURCE_DIR }}
          make install

          # Verify installation
          INSTALL_PREFIX="${{ env.OUTPUT_DIR }}/${{ env.BINARY_NAME }}"
          "$INSTALL_PREFIX/bin/php" --version
          "$INSTALL_PREFIX/bin/php" -m # Show loaded modules

      - name: Create binary package
        run: |
          cd ${{ env.OUTPUT_DIR }}

          # Create metadata file
          cat > ${{ env.BINARY_NAME }}/metadata.json << EOF
          {
            "php_version": "${{ matrix.php_version }}",
            "platform": "${{ matrix.platform }}",
            "architecture": "${{ matrix.arch }}",
            "configuration": "${{ matrix.config }}",
            "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "built_by": "GitHub Actions",
            "commit": "${{ github.sha }}",
            "extensions": "$(echo '${{ env.CONFIGURE_EXTENSIONS }}' | tr ' ' '\n' | grep -E '^--(enable|with)-' | sed 's/^--[^-]*-//' | sort | tr '\n' ',' | sed 's/,$//')"
          }
          EOF

          # Create tarball
          tar -czf ${{ env.BINARY_NAME }}.tar.gz ${{ env.BINARY_NAME }}/

          # Show package info
          echo "Created package: ${{ env.BINARY_NAME }}.tar.gz"
          ls -lh ${{ env.BINARY_NAME }}.tar.gz

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}
          path: ${{ env.OUTPUT_DIR }}/${{ env.BINARY_NAME }}.tar.gz
          retention-days: 90

      - name: Upload to GitHub Container Registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY_URL }} -u ${{ env.REGISTRY_USERNAME }} --password-stdin

          # Create a simple Dockerfile for the binary
          cd ${{ env.OUTPUT_DIR }}
          cat > Dockerfile << EOF
          FROM scratch
          COPY ${{ env.BINARY_NAME }}.tar.gz /php-binary.tar.gz
          EOF

          # Build and push
          IMAGE_TAG="${{ env.REGISTRY_URL }}/${{ github.repository_owner }}/php-binaries:${{ env.BINARY_NAME }}"
          docker build -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"

  # Release job to create GitHub releases with binaries
  create-release:
    needs: build-matrix
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries/

      - name: Create release manifest
        run: |
          cd binaries/

          # Create a manifest of all built binaries
          cat > manifest.json << EOF
          {
            "version": "$(date +%Y.%m.%d)",
            "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "binaries": [
          EOF

          first=true
          for dir in */; do
            if [[ -f "$dir"*.tar.gz ]]; then
              if [[ $first == "false" ]]; then
                echo "," >> manifest.json
              fi
              tarball=$(ls "$dir"*.tar.gz | head -1)
              filename=$(basename "$tarball")
              size=$(stat -c%s "$tarball" 2>/dev/null || stat -f%z "$tarball")

              # Extract metadata from tarball if available
              tar -xzOf "$tarball" "*/metadata.json" > temp_metadata.json 2>/dev/null || echo '{}' > temp_metadata.json

              echo "      {" >> manifest.json
              echo "        \"filename\": \"$filename\"," >> manifest.json
              echo "        \"size\": $size," >> manifest.json
              cat temp_metadata.json | sed 's/^/        /' | sed '1s/^        {//' | sed '$s/$//' >> manifest.json
              echo "      }" >> manifest.json
              first=false
            fi
          done

          echo "    ]" >> manifest.json
          echo "  }" >> manifest.json

          cat manifest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: binaries-${{ github.run_number }}
          name: PHP Precompiled Binaries - Build ${{ github.run_number }}
          body: |
            ðŸš€ **PHP Precompiled Binaries**

                        This release contains precompiled PHP binaries optimized for Laravel and modern PHP frameworks:

            - **Platforms**: Linux (x86_64), macOS (ARM64 & Intel)
            - **PHP Versions**: 8.4.11, 8.3.14, 8.2.26, 8.1.30
            - **Laravel-Optimized Configurations**:
              - `laravel-mysql`: Laravel with MySQL/MariaDB (most common)
              - `laravel-postgres`: Laravel with PostgreSQL (enterprise)
              - `laravel-sqlite`: Laravel with SQLite (development/testing)
              - `api-only`: API-only applications (minimal footprint)
              - `enterprise`: Full-featured Laravel with all extensions
              - `wordpress`: WordPress optimized build

            ðŸ“¦ **Usage with Launchpad**:
            These binaries are automatically downloaded by Launchpad instead of compiling from source.

            ðŸ”§ **Built from commit**: ${{ github.sha }}

            See `manifest.json` for detailed information about each binary.
          files: |
            binaries/**/*.tar.gz
            binaries/manifest.json
          draft: false
          prerelease: false
