name: Sync Pre-Built Binaries

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      packages:
        description: 'Comma-separated package domains (empty = all pre-built)'
        required: false
        type: string
      force:
        description: 'Force re-upload even if already in S3'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  S3_BUCKET: pantry-registry

jobs:
  # Job 1: Sync the 12 pre-built binary packages (fast downloads, no compilation)
  sync-prebuilt:
    name: Sync pre-built (${{ matrix.platform }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin-arm64
          - os: ubuntu-latest
            platform: linux-x86-64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Link ts-cloud from source
        run: |
          git clone --depth 1 https://github.com/stacksjs/ts-cloud.git /tmp/ts-cloud
          cd /tmp/ts-cloud && bun install
          rm -rf ${{ github.workspace }}/node_modules/@stacksjs/ts-cloud
          mkdir -p ${{ github.workspace }}/node_modules/@stacksjs
          ln -s /tmp/ts-cloud/packages/ts-cloud ${{ github.workspace }}/node_modules/@stacksjs/ts-cloud

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libreadline-dev zlib1g-dev

      - name: Sync pre-built binaries to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd packages/ts-pantry

          PKGS="${{ github.event.inputs.packages || '' }}"
          FORCE="${{ github.event.inputs.force || 'false' }}"

          ARGS="-b $S3_BUCKET -r $AWS_REGION"

          if [ "$FORCE" = "true" ]; then
            ARGS="$ARGS --force"
          fi

          if [ -n "$PKGS" ]; then
            IFS=',' read -ra DOMAINS <<< "$PKGS"
            for d in "${DOMAINS[@]}"; do
              d=$(echo "$d" | xargs) # trim whitespace
              ARGS="$ARGS -p $d"
            done
          fi

          echo "Running: bun scripts/sync-packages.ts $ARGS"
          bun scripts/sync-packages.ts $ARGS
        timeout-minutes: 60

  # Job 2: Discover how many buildable packages exist for batching
  discover:
    name: Discover buildable packages
    runs-on: ubuntu-latest
    outputs:
      batches: ${{ steps.discover.outputs.batches }}
      total: ${{ steps.discover.outputs.total }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Link ts-cloud from source
        run: |
          git clone --depth 1 https://github.com/stacksjs/ts-cloud.git /tmp/ts-cloud
          cd /tmp/ts-cloud && bun install
          rm -rf ${{ github.workspace }}/node_modules/@stacksjs/ts-cloud
          mkdir -p ${{ github.workspace }}/node_modules/@stacksjs
          ln -s /tmp/ts-cloud/packages/ts-cloud ${{ github.workspace }}/node_modules/@stacksjs/ts-cloud

      - name: Discover packages
        id: discover
        run: |
          cd packages/ts-pantry
          TOTAL=$(bun scripts/build-all-packages.ts --count-only 2>/dev/null | tail -1)
          echo "total=$TOTAL"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          BATCH_SIZE=50
          LAST_BATCH=$(( (TOTAL - 1) / BATCH_SIZE ))
          # Generate JSON array [0, 1, 2, ..., LAST_BATCH]
          BATCHES=$(python3 -c "import json; print(json.dumps(list(range($LAST_BATCH + 1))))")
          echo "batches=$BATCHES"
          echo "batches=$BATCHES" >> $GITHUB_OUTPUT

  # Job 3: Build packages from source in batches
  build:
    name: Build batch ${{ matrix.batch }} (${{ matrix.platform.name }})
    needs: discover
    if: needs.discover.outputs.total != '0'
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        batch: ${{ fromJson(needs.discover.outputs.batches) }}
        platform:
          - os: macos-14
            name: darwin-arm64
          - os: ubuntu-latest
            name: linux-x86-64
    runs-on: ${{ matrix.platform.os }}
    permissions:
      contents: read
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Link ts-cloud from source
        run: |
          git clone --depth 1 https://github.com/stacksjs/ts-cloud.git /tmp/ts-cloud
          cd /tmp/ts-cloud && bun install
          rm -rf ${{ github.workspace }}/node_modules/@stacksjs/ts-cloud
          mkdir -p ${{ github.workspace }}/node_modules/@stacksjs
          ln -s /tmp/ts-cloud/packages/ts-cloud ${{ github.workspace }}/node_modules/@stacksjs/ts-cloud

      - name: Install build tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libreadline-dev zlib1g-dev libssl-dev \
            cmake meson ninja-build patchelf pkg-config \
            autoconf automake libtool gettext \
            libffi-dev libexpat1-dev libbz2-dev liblzma-dev \
            libncurses5-dev libsqlite3-dev \
            python3-venv python3-pip python3-dev \
            libcurl4-openssl-dev libxml2-dev libonig-dev \
            ruby ruby-dev scons \
            gperf bison flex texinfo \
            libgmp-dev libmpfr-dev libmpc-dev \
            libuv1-dev libpcre2-dev libevent-dev \
            libglib2.0-dev libpixman-1-dev \
            libgit2-dev libssh2-1-dev libhttp-parser-dev \
            libasound2-dev libdbus-1-dev libsystemd-dev \
            libx11-dev libxrandr-dev libxi-dev libxcursor-dev \
            libxkbcommon-dev libwayland-dev libfontconfig1-dev \
            protobuf-compiler libprotobuf-dev \
            nettle-dev libp11-kit-dev \
            libboost-all-dev libsndfile1-dev \
            libjpeg-dev libpng-dev libtiff-dev libwebp-dev \
            libfreetype-dev libharfbuzz-dev \
            libltdl-dev libacl1-dev libattr1-dev \
            liblz4-dev libzstd-dev libxxhash-dev \
            libyaml-dev libjansson-dev \
            libedit-dev libelf-dev \
            tcl-dev tk-dev \
            libunwind-dev libdw-dev

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake meson ninja pkg-config autoconf automake libtool gettext gnu-sed scons \
            boost libsndfile jpeg-turbo libpng libtiff webp freetype harfbuzz \
            libyaml jansson libedit

      - name: Setup Rust toolchain
        run: |
          if ! command -v cargo &>/dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
            source "$HOME/.cargo/env"
          fi
          # Ensure pip packages needed for building are available
          pip3 install setuptools meson 2>/dev/null || python3 -m pip install setuptools meson 2>/dev/null || true

      - name: Verify toolchains
        run: |
          echo "=== Toolchain versions ==="
          cargo --version 2>/dev/null || echo "cargo: not found"
          rustc --version 2>/dev/null || echo "rustc: not found"
          go version 2>/dev/null || echo "go: not found"
          python3 --version 2>/dev/null || echo "python3: not found"
          node --version 2>/dev/null || echo "node: not found"
          java -version 2>/dev/null || echo "java: not found"
          echo "HOME=$HOME"
          echo "CARGO_HOME=${CARGO_HOME:-not set}"
          echo "GOPATH=${GOPATH:-not set}"
          echo "JAVA_HOME=${JAVA_HOME:-not set}"
          which cargo 2>/dev/null || echo "cargo not in PATH"
          which go 2>/dev/null || echo "go not in PATH"
          which java 2>/dev/null || echo "java not in PATH"

      - name: Build batch ${{ matrix.batch }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd packages/ts-pantry

          FORCE="${{ github.event.inputs.force || 'false' }}"
          ARGS="-b $S3_BUCKET -r $AWS_REGION --batch ${{ matrix.batch }} --batch-size 50 --platform ${{ matrix.platform.name }}"

          if [ "$FORCE" = "true" ]; then
            ARGS="$ARGS --force"
          fi

          echo "Running: bun scripts/build-all-packages.ts $ARGS"
          bun scripts/build-all-packages.ts $ARGS
        timeout-minutes: 110
